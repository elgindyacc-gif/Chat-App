import{c as _,r as a,j as t,B as b,R as Y,t as Z}from"./index-D7he1i6_.js";import{A as I,a as ee}from"./avatar-CAwhaa4I.js";import{M as te,V as re,a as se}from"./volume-2-COawAZmK.js";import{V as ae}from"./volume-x-BpyXwvjb.js";import{P as oe}from"./phone-off-B1J4Qt6V.js";/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ne=[["line",{x1:"2",x2:"22",y1:"2",y2:"22",key:"a6p6uj"}],["path",{d:"M18.89 13.23A7.12 7.12 0 0 0 19 12v-2",key:"80xlxr"}],["path",{d:"M5 10v2a7 7 0 0 0 12 5",key:"p2k8kg"}],["path",{d:"M15 9.34V5a3 3 0 0 0-5.68-1.33",key:"1gzdoj"}],["path",{d:"M9 9v3a3 3 0 0 0 5.12 2.12",key:"r2i35w"}],["line",{x1:"12",x2:"12",y1:"19",y2:"22",key:"x3vr5v"}]],ce=_("mic-off",ne);/**
 * @license lucide-react v0.487.0 - ISC
 *
 * This source code is licensed under the ISC license.
 * See the LICENSE file in the root directory of this source tree.
 */const ie=[["path",{d:"M10.66 6H14a2 2 0 0 1 2 2v2.5l5.248-3.062A.5.5 0 0 1 22 7.87v8.196",key:"w8jjjt"}],["path",{d:"M16 16a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h2",key:"1xawa7"}],["path",{d:"m2 2 20 20",key:"1ooewy"}]],le=_("video-off",ie);function ge({callId:p,callerId:y,callerName:v,recipientId:N,isIncoming:h,type:c,onEndCall:V,currentUserId:A,sendSignaling:j,incomingOffer:M,remoteAnswer:R,remoteIceCandidates:E}){const[x,B]=a.useState("ringing"),[O,F]=a.useState(0),[k,H]=a.useState(!1),[w,U]=a.useState(c==="audio"),[g,G]=a.useState(!0),[P,W]=a.useState("user"),[o,D]=a.useState(null),[m,z]=a.useState(null),s=a.useRef(null),T=a.useRef(null),u=a.useRef(null),f=a.useRef(null),X={iceServers:[{urls:"stun:stun.l.google.com:19302"},{urls:"stun:stun1.l.google.com:19302"},{urls:"stun:stun2.l.google.com:19302"},{urls:"stun:stun3.l.google.com:19302"},{urls:"stun:stun4.l.google.com:19302"}],iceCandidatePoolSize:10},S=(r,e,n)=>{const i=r.split(`
`);let l=-1;for(let d=0;d<i.length;d++)if(i[d].indexOf("m="+e)===0){l=d;break}if(l===-1)return r;for(l++;l<i.length&&i[l].indexOf("m=")!==0;){if(i[l].indexOf("b=AS:")===0)return i[l]="b=AS:"+n,i.join(`
`);l++}return i.splice(l,0,"b=AS:"+n),i.join(`
`)},$=a.useCallback(()=>{o==null||o.getTracks().forEach(r=>r.stop()),s.current&&(s.current.onicecandidate=null,s.current.ontrack=null,s.current.close(),s.current=null),D(null),z(null)},[o]),C=a.useCallback(()=>{$(),V()},[$,V]);a.useEffect(()=>{let r;return x==="connected"&&(r=setInterval(()=>{F(e=>e+1)},1e3)),()=>clearInterval(r)},[x]);const L=r=>{const e=Math.floor(r/60),n=r%60;return`${e}:${n.toString().padStart(2,"0")}`};a.useEffect(()=>{(async()=>{try{o==null||o.getTracks().forEach(n=>n.stop());const e=await navigator.mediaDevices.getUserMedia({audio:{echoCancellation:!0,noiseSuppression:!0,autoGainControl:!0},video:c==="video"?{facingMode:P,width:{ideal:1280,max:1920},height:{ideal:720,max:1080},frameRate:{ideal:30,max:60}}:!1});if(D(e),s.current){const n=e.getVideoTracks()[0],i=s.current.getSenders().find(l=>{var d;return((d=l.track)==null?void 0:d.kind)==="video"});i&&n&&i.replaceTrack(n)}}catch(e){console.error("getUserMedia failed:",e),Z.error("كاميرا أو ميكروفون غير متاح. تأكد من استخدام HTTPS وإعطاء الأذونات."),C()}})()},[c,P]),a.useEffect(()=>{T.current&&o&&(T.current.srcObject=o)},[o]),a.useEffect(()=>o?((async()=>{try{if(!s.current){const e=new RTCPeerConnection(X);s.current=e,e.ontrack=n=>{console.log("Remote track received"),z(n.streams[0]),B("connected")},e.onicecandidate=n=>{n.candidate&&j(h?y:N,"ice-candidate",{id:p,candidate:n.candidate})},e.oniceconnectionstatechange=()=>{(e.iceConnectionState==="disconnected"||e.iceConnectionState==="failed")&&console.log("ICE failed/disconnected")},o.getTracks().forEach(n=>e.addTrack(n,o))}if(h&&M&&s.current.signalingState==="stable"){await s.current.setRemoteDescription(new RTCSessionDescription(M));let e=await s.current.createAnswer();e.sdp=S(e.sdp,"audio",64),c==="video"&&(e.sdp=S(e.sdp,"video",1e3)),await s.current.setLocalDescription(e),j(y,"call-answer",{id:p,answer:e})}else if(!h&&s.current.signalingState==="stable"){let e=await s.current.createOffer();e.sdp=S(e.sdp,"audio",64),c==="video"&&(e.sdp=S(e.sdp,"video",1e3)),await s.current.setLocalDescription(e),j(N,"call-offer",{id:p,callerId:A,callerName:v,type:c,offer:e})}}catch(e){console.error("PC init failed:",e),C()}})(),()=>{}):void 0,[o,p,h,M,c,A,v,j,C,y,N]),a.useEffect(()=>{R&&s.current&&s.current.signalingState==="have-local-offer"&&s.current.setRemoteDescription(new RTCSessionDescription(R)).catch(r=>console.error("Error setting answer:",r))},[R]),a.useEffect(()=>{E&&s.current&&s.current.remoteDescription&&E.forEach(r=>{var e;(e=s.current)==null||e.addIceCandidate(new RTCIceCandidate(r)).catch(n=>console.error("Error adding candidate:",n))})},[E]),a.useEffect(()=>{u.current&&m&&c==="video"?(u.current.srcObject=m,u.current.play().catch(r=>console.warn("Auto-play blocked:",r))):f.current&&m&&c==="audio"&&(f.current.srcObject=m,f.current.play().catch(r=>console.warn("Auto-play blocked:",r)))},[m,c]);const q=()=>{if(o){const r=o.getAudioTracks()[0];r&&(r.enabled=k,H(!k))}},J=()=>{if(o&&c==="video"){const r=o.getVideoTracks()[0];r&&(r.enabled=w,U(!w))}},K=()=>{G(!g),u.current&&(u.current.muted=!g),f.current&&(f.current.muted=!g)},Q=()=>{W(r=>r==="user"?"environment":"user")};return t.jsxs("div",{className:"fixed inset-0 z-[1000] bg-[#111b21] flex flex-col items-center justify-center p-4",children:[c==="video"?t.jsx("video",{ref:u,autoPlay:!0,playsInline:!0,className:"absolute inset-0 w-full h-full object-cover"}):t.jsxs("div",{className:"flex flex-col items-center gap-6 mb-20",children:[t.jsx(I,{className:"w-32 h-32 border-4 border-[#00a884]/30 shadow-2xl scale-in-center",children:t.jsx(ee,{className:"bg-[#202c33] text-[#00a884] text-4xl font-bold",children:v.charAt(0).toUpperCase()})}),t.jsxs("div",{className:"text-center",children:[t.jsx("h2",{className:"text-white text-3xl font-bold mb-2",children:v}),t.jsxs("div",{className:"flex flex-col items-center gap-2",children:[t.jsx("p",{className:"text-[#00a884] font-medium animate-pulse uppercase tracking-widest text-xs",children:x==="ringing"?h?"مكالمة واردة...":"جاري الاتصال...":"متصل"}),x==="connected"&&t.jsx("p",{className:"text-white/60 font-mono text-lg",children:L(O)})]})]}),t.jsx("audio",{ref:f,autoPlay:!0})]}),c==="video"&&x==="connected"&&t.jsx("div",{className:"absolute top-20 left-1/2 -translate-x-1/2 z-20 bg-black/40 px-4 py-1 rounded-full backdrop-blur-md border border-white/10",children:t.jsx("p",{className:"text-white font-mono",children:L(O)})}),c==="video"&&o&&t.jsx("div",{className:"absolute top-6 right-6 w-32 md:w-48 aspect-[3/4] rounded-xl overflow-hidden shadow-2xl border-2 border-white/20 z-10",children:t.jsx("video",{ref:T,autoPlay:!0,playsInline:!0,muted:!0,className:"w-full h-full object-cover -scale-x-100"})}),t.jsxs("div",{className:"absolute bottom-12 flex items-center gap-6 bg-[#202c33]/90 backdrop-blur-xl p-6 rounded-full border border-white/10 shadow-2xl z-20",children:[t.jsx(b,{onClick:q,className:`w-14 h-14 rounded-full transition-all ${k?"bg-red-500 hover:bg-red-600":"bg-gray-700 hover:bg-gray-600"}`,children:k?t.jsx(ce,{}):t.jsx(te,{})}),c==="video"&&t.jsxs(t.Fragment,{children:[t.jsx(b,{onClick:J,className:`w-14 h-14 rounded-full transition-all ${w?"bg-red-500 hover:bg-red-600":"bg-gray-700 hover:bg-gray-600"}`,children:w?t.jsx(le,{}):t.jsx(re,{})}),t.jsx(b,{onClick:Q,className:"w-14 h-14 rounded-full bg-gray-700 hover:bg-gray-600 transition-all",children:t.jsx(Y,{className:"w-6 h-6"})})]}),t.jsx(b,{onClick:K,className:`w-14 h-14 rounded-full ${g?"bg-gray-700":"bg-red-500"}`,children:g?t.jsx(se,{}):t.jsx(ae,{})}),t.jsx(b,{onClick:C,className:"w-16 h-16 rounded-full bg-red-600 hover:bg-red-700 flex items-center justify-center",children:t.jsx(oe,{className:"w-8 h-8"})})]})]})}export{ge as CallWindow};
