import{r as u,j as e,m as c,A as z,I,L as g,a as J,U as L,B as q,s as d,t as b}from"./index-D7he1i6_.js";import{S as M}from"./search-BeOaeq5H.js";import{U as R}from"./users-CWNW1A_V.js";function B({onBack:C,currentUserId:o,language:s,t:k}){const[p,w]=u.useState(""),[a,v]=u.useState("user"),[i,l]=u.useState(null),[j,N]=u.useState(!1),[$,n]=u.useState(!1),[m,f]=u.useState(!1),F=async()=>{if(!p.trim())return;const r=p.trim().toLowerCase().replace(a==="user"?"@":"#","");N(!0),n(!1),l(null),await new Promise(t=>setTimeout(t,600));try{if(a==="user"){const{data:t}=await d.from("profiles").select("id, display_name, username").eq("username",r).maybeSingle();if(t){if(t.id===o){n(!0);return}const{data:x}=await d.from("conversation_participants").select("conversation_id").eq("user_id",t.id),_=(x==null?void 0:x.map(y=>y.conversation_id))||[];let S=!1;if(_.length>0){const{data:y}=await d.from("conversation_participants").select("conversation_id").eq("user_id",o).in("conversation_id",_).maybeSingle();S=!!y}const{data:h}=await d.from("chat_requests").select("status, sender_id").or(`and(sender_id.eq.${o},receiver_id.eq.${t.id}),and(sender_id.eq.${t.id},receiver_id.eq.${o})`).maybeSingle();l({id:t.id,identifier:t.username,name:t.display_name||t.username,hasChat:S,requestStatus:h==null?void 0:h.status,requestSenderId:h==null?void 0:h.sender_id})}else n(!0)}else{const{data:t}=await d.from("groups").select("id, name, group_id, description").eq("group_id",r).maybeSingle();if(t){const{data:x}=await d.from("group_members").select("id").eq("group_id",t.id).eq("user_id",o).maybeSingle();l({id:t.id,identifier:t.group_id,name:t.name,description:t.description,isMember:!!x})}else n(!0)}}catch(t){console.error("Search error:",t),n(!0)}finally{N(!1)}},G=async()=>{if(!(!i||m)){f(!0);try{const{error:r}=await d.from("chat_requests").upsert({sender_id:o,receiver_id:i.id,status:"pending"},{onConflict:"sender_id,receiver_id"});if(r)throw r;b.success(s==="ar"?"تم إرسال الطلب بنجاح!":"Request sent successfully!"),l(t=>t?{...t,requestStatus:"pending",requestSenderId:o}:null)}catch(r){b.error(r.message||(s==="ar"?"فشل إرسال الطلب":"Failed to send request"))}finally{f(!1)}}},T=async()=>{if(!(!i||m)){f(!0);try{const{error:r}=await d.from("group_members").insert({group_id:i.id,user_id:o,role:"member"});if(r)throw r;b.success(s==="ar"?"تم الانضمام للمجموعة بنجاح!":"Joined group successfully!"),l(t=>t?{...t,isMember:!0}:null)}catch(r){console.error("Join group error:",r),b.error(s==="ar"?"فشل الانضمام للمجموعة":"Failed to join group")}finally{f(!1)}}};return e.jsxs("div",{className:"flex flex-col h-[100dvh] bg-slate-950 text-white overflow-hidden relative",children:[e.jsx("div",{className:"absolute top-0 right-0 w-full h-full bg-gradient-to-bl from-indigo-900/10 to-transparent pointer-events-none"}),e.jsxs("div",{className:"px-4 py-4 flex items-center gap-3 relative z-10 border-b border-white/5 bg-slate-900/50 backdrop-blur-sm",children:[e.jsx(c.button,{whileHover:{scale:1.1},whileTap:{scale:.9},onClick:C,className:"text-slate-400 hover:text-white transition-colors p-1 rounded-full hover:bg-white/5",children:e.jsx(z,{className:`w-6 h-6 ${s==="ar"?"rotate-180":""}`})}),e.jsx("h2",{className:`text-xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-white to-slate-400 ${s==="ar"?"font-arabic":""}`,children:k("newChat")})]}),e.jsxs("div",{className:"flex border-b border-white/5 relative z-10",children:[e.jsxs("button",{type:"button",onClick:()=>{v("user"),l(null),n(!1),w("")},className:`flex-1 py-4 text-sm font-bold transition-all relative ${a==="user"?"text-indigo-400":"text-slate-500 hover:text-slate-300"} ${s==="ar"?"font-arabic":""}`,children:[s==="ar"?"بحث عن مستخدم":"Find User",a==="user"&&e.jsx(c.div,{layoutId:"tab-indicator",className:"absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]"})]}),e.jsxs("button",{type:"button",onClick:()=>{v("group"),l(null),n(!1),w("")},className:`flex-1 py-4 text-sm font-bold transition-all relative ${a==="group"?"text-indigo-400":"text-slate-500 hover:text-slate-300"} ${s==="ar"?"font-arabic":""}`,children:[s==="ar"?"بحث عن مجموعة":"Find Group",a==="group"&&e.jsx(c.div,{layoutId:"tab-indicator",className:"absolute bottom-0 left-0 right-0 h-0.5 bg-indigo-500 shadow-[0_0_10px_rgba(99,102,241,0.5)]"})]})]}),e.jsx("div",{className:"flex-1 px-4 py-8 overflow-y-auto relative z-10",children:e.jsxs("div",{className:"max-w-md mx-auto",children:[e.jsx(c.p,{initial:{opacity:0},animate:{opacity:1},className:"text-slate-400 mb-6 text-center text-sm",children:a==="user"?s==="ar"?"ابحث عن المستخدمين من خلال اسم المستخدم الخاص بهم (مثلاً elgin@)":"Search for users by their username (e.g. @elgin)":s==="ar"?"ابحث عن المجموعات من خلال معرّف المجموعة (مثلاً #developers)":"Search for groups by their Group ID (e.g. #developers)"}),e.jsxs("form",{onSubmit:r=>{r.preventDefault(),F()},className:"flex gap-2 mb-8 relative z-50",children:[e.jsxs("div",{className:"relative flex-1 group",children:[e.jsx("span",{className:"absolute left-3 top-1/2 -translate-y-1/2 text-indigo-500 font-bold pointer-events-none text-lg",children:a==="user"?"@":"#"}),e.jsx(I,{type:"text",inputMode:"search",autoComplete:"off",autoCorrect:"off",spellCheck:"false",placeholder:a==="user"?s==="ar"?"اسم المستخدم":"username":s==="ar"?"معرّف-المجموعة":"group-id",value:p,onChange:r=>{w(r.target.value),n(!1),l(null)},className:"pl-8 bg-slate-900/50 border-white/5 focus:border-indigo-500/50 focus:ring-1 focus:ring-indigo-500/50 rounded-xl text-white placeholder:text-slate-600 h-12 text-lg font-medium transition-all"})]}),e.jsx(c.button,{whileHover:{scale:1.05},whileTap:{scale:.95},type:"submit",disabled:j||!p.trim(),className:"bg-indigo-600 hover:bg-indigo-500 disabled:opacity-50 text-white h-12 w-12 rounded-xl flex items-center justify-center transition-all shadow-lg shadow-indigo-500/20",children:e.jsx(M,{className:"w-6 h-6 pointer-events-none"})})]}),j&&e.jsxs("div",{className:"flex flex-col items-center justify-center text-slate-400 py-8 gap-2",children:[e.jsx(g,{className:"w-8 h-8 animate-spin text-indigo-500"}),e.jsx("span",{className:"text-xs animate-pulse",children:s==="ar"?"جاري البحث في الشبكة...":"Searching the network..."})]}),$&&e.jsxs(c.div,{initial:{opacity:0,scale:.9},animate:{opacity:1,scale:1},className:"bg-slate-900/50 border border-white/5 rounded-2xl p-6 text-center",children:[e.jsxs("p",{className:"text-slate-300 font-medium text-lg",children:[a==="user"?s==="ar"?"المستخدم":"User":s==="ar"?"المجموعة":"Group"," ",s==="ar"?"غير موجود":"not found"]}),e.jsx("p",{className:"text-slate-500 text-sm mt-2",children:s==="ar"?"تحقق من المعرّف وحاول مرة أخرى.":"Check the ID and try again."})]}),e.jsx(J,{children:i&&e.jsxs(c.div,{initial:{opacity:0,y:20},animate:{opacity:1,y:0},exit:{opacity:0,scale:.9},className:"bg-slate-900/80 backdrop-blur-xl border border-white/10 rounded-2xl p-6 shadow-2xl relative overflow-hidden",children:[e.jsx("div",{className:"absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-indigo-500"}),e.jsxs("div",{className:"flex items-center justify-between mb-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-white text-xl font-bold",children:i.name}),e.jsxs("p",{className:"text-indigo-400 text-sm font-medium bg-indigo-500/10 px-2 py-0.5 rounded-md w-fit mt-1",children:[a==="user"?"@":"#",i.identifier]}),i.description&&e.jsx("p",{className:"text-slate-400 text-sm mt-2 leading-relaxed",children:i.description})]}),e.jsx("div",{className:"w-14 h-14 bg-gradient-to-br from-indigo-600 to-violet-600 rounded-2xl flex items-center justify-center text-white shadow-lg shadow-indigo-500/20 rotate-3",children:a==="user"?e.jsx(L,{className:"w-7 h-7"}):e.jsx(R,{className:"w-7 h-7"})})]}),a==="user"?i.hasChat?e.jsx("div",{className:"bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded-xl py-3 text-center text-sm font-medium",children:s==="ar"?"لديك دردشة بالفعل مع هذا المستخدم":"You already have a chat with this user"}):i.requestStatus==="pending"?e.jsx("div",{className:"bg-yellow-500/10 text-yellow-400 border border-yellow-500/20 rounded-xl py-3 text-center text-sm font-medium",children:i.requestSenderId===o?s==="ar"?"الطلب قيد الانتظار...":"Request Pending...":s==="ar"?"أرسل إليك طلباً!":"Sent you a request!"}):e.jsx(q,{onClick:G,disabled:m,className:"w-full h-12 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/25 transition-all text-base",children:m?e.jsx(g,{className:"w-5 h-5 animate-spin"}):s==="ar"?"إرسال طلب دردشة":"Send Chat Request"}):i.isMember?e.jsx("div",{className:"bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 rounded-xl py-3 text-center text-sm font-medium",children:s==="ar"?"أنت عضو بالفعل في هذه المجموعة":"You are already a member"}):e.jsx(q,{onClick:T,disabled:m,className:"w-full h-12 bg-indigo-600 hover:bg-indigo-500 text-white font-bold rounded-xl shadow-lg shadow-indigo-500/25 transition-all text-base",children:m?e.jsx(g,{className:"w-5 h-5 animate-spin"}):s==="ar"?"انضمام للمجموعة":"Join Group"})]})})]})})]})}export{B as NewChat};
